<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å¤šè¯­è¨€æœ¬åœŸåŒ–ç¿»è¯‘ï¼ˆè¡¨æ ¼é¢„è§ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">
<style>
  :root{
    --brand:#2b6cb0; --brand-dark:#1a4f80; --bg:#f0f2f5;
    --ok:#10b981; --warn:#ef4444;
  }
  body{
    font-family:"Segoe UI", Arial, sans-serif;
    background:var(--bg); margin:0; padding:28px; color:#333;
    display:flex; justify-content:center; align-items:flex-start;
  }
  .container{
    background:#fff; border-radius:14px; padding:22px; width:100%; max-width:980px;
    box-shadow:0 6px 20px rgba(0,0,0,.08);
  }
  h1{ margin:0 0 12px; text-align:center; color:var(--brand); font-size:1.8rem; }
  .sub{ text-align:center; color:#666; margin-bottom:18px; }
  label{ font-weight:700; display:block; margin-top:12px; }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  textarea{
    width:100%; min-height:140px; padding:12px; border:1px solid #d1d5db; border-radius:10px; resize:vertical; font-size:14px;
  }
  .muted{ color:#666; }
  .btn{
    border:none; border-radius:10px; padding:11px 14px; font-weight:700; cursor:pointer; color:#fff;
    background:var(--brand); transition:background .15s, transform .05s;
  }
  .btn:hover{ background:var(--brand-dark); }
  .btn-ghost{ background:#e5e7eb; color:#111; }
  .btn-ok{ background:var(--ok); }
  .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
  .status{ margin-top:8px; font-size:14px; }
  .status.ok{ color:var(--ok); }
  .status.warn{ color:var(--warn); }
  .table-wrap{
    margin-top:16px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px;
  }
  table{ width:100%; border-collapse:separate; border-spacing:0; }
  thead th{
    position:sticky; top:0; background:#f8fafc; z-index:1; 
    border-bottom:1px solid #e5e7eb; padding:10px; font-weight:800; text-transform:uppercase; font-size:13px;
    letter-spacing:0.02em;
  }
  tbody td{
    padding:10px; border-bottom:1px solid #f1f5f9; vertical-align:top; font-size:14px;
  }
  tbody tr:nth-child(odd){ background:#fcfcfd; }
  .missing{ background:#fee2e2; }
  .right-tools{ display:flex; gap:10px; justify-content:flex-end; }
  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
    background:#111; color:#fff; padding:10px 14px; border-radius:8px; opacity:0;
    transition:opacity .2s, transform .2s; pointer-events:none; font-size:14px;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }
  .hint{ font-size:12px; color:#6b7280; margin-top:6px; }

  /* æ‹–æ‹½è¡¨å¤´æ ·å¼ */
  .header-drag-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
  }
  .header-drag-list li {
    background: #f0f3f7;
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    cursor: grab;
    user-select: none;
    transition: background 0.2s;
  }
  .header-drag-list li:hover {
    background: #e2e6eb;
  }
  .header-drag-list li.dragging {
    opacity: 0.5;
    background: #cfd6de;
  }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸŒ å¤šè¯­è¨€æœ¬åœŸåŒ–ç¿»è¯‘</h1>
  <div class="sub">è¾“å…¥å¤šè¡Œè‹±æ–‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼Œåç«¯è¿”å› TSVï¼Œå‰ç«¯æ¸²æŸ“è¡¨æ ¼å¹¶è‡ªæ£€ã€‚</div>

  <label>æºè¯­è¨€ï¼ˆå›ºå®šï¼‰ï¼š</label>
  <div class="row">
    <input type="text" value="è‹±è¯­" disabled style="background:#f3f4f6;border:1px solid #d1d5db;border-radius:10px;padding:10px;">
    <div class="muted" style="display:flex;align-items:center;"></div>
  </div>

  <label>è¾“å…¥è¦ç¿»è¯‘çš„è¯æ±‡ï¼ˆè‹±æ–‡ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¸€æ¬¡ä¸è¦è¶…å‡º50ä¸ªï¼Œè¿™æ˜ŸæœŸä¼šä¼˜åŒ–ï¼‰ï¼š</label>
  <textarea id="sourceText" placeholder="ç¤ºä¾‹ï¼š&#10;AI Stem Splitter&#10;Free Key and BPM Finder | Find Song Key &amp; BPM Online&#10;AUDIO-ZU-MIDI &lt;br&gt;&lt;/br&gt; Convert"></textarea>

  <label>æœ€ä½³æœ¬åœŸåŒ–ç¿»è¯‘ç¤ºä¾‹ï¼ˆå¯é€‰ï¼Œå¤šè¡Œï¼‰ï¼š</label>
  <textarea id="bestExamples" placeholder="ç¤ºä¾‹æ ¼å¼ï¼š&#10;AI Stem Splitter => AI éŸ³è½¨åˆ†ç¦»å™¨&#10;Free Key and BPM Finder => å…è´¹è°ƒæ€§ä¸BPMæ£€æµ‹å·¥å…·"></textarea>
  <div class="hint">è¿™äº›ç¤ºä¾‹ä¼šä½œä¸ºå‚è€ƒæ‹¼æ¥åˆ° AI æç¤ºä¸­ï¼Œå¸®åŠ©ç”Ÿæˆæ›´ç¬¦åˆä½ è¦æ±‚çš„ç¿»è¯‘ã€‚</div>


  <!-- æ‹–æ‹½è¡¨å¤´é¡ºåº -->
  <div class="header-drag-container">
    <label>æ‹–åŠ¨è°ƒæ•´è¯­è¨€é¡ºåºï¼š</label>
    <ul id="headerList" class="header-drag-list">
      <li draggable="true" data-code="zh">zh</li>
      <li draggable="true" data-code="ja">ja</li>
      <li draggable="true" data-code="de">de</li>
      <li draggable="true" data-code="pt">pt</li>
      <li draggable="true" data-code="es">es</li>
      <li draggable="true" data-code="fr">fr</li>
      <li draggable="true" data-code="ko">ko</li>
      <li draggable="true" data-code="tw">tw</li>
      <li draggable="true" data-code="vi">vi</li>
    </ul>
  </div>

  <div class="actions">
    <button id="runBtn" class="btn">ğŸš€ ç¿»è¯‘å¹¶ç”Ÿæˆè¡¨æ ¼</button>
    <div class="right-tools" style="margin-left:auto;">
      <button id="copyBtn" class="btn btn-ok">ğŸ“‹ å¤åˆ¶ TSV</button>
      <button id="dlBtn" class="btn btn-ghost">â¬‡ï¸ ä¸‹è½½ TSV</button>
    </div>
  </div>
  <div id="status" class="status muted">å¾…ç¿»è¯‘</div>

  <div class="table-wrap" id="tableWrap" style="display:none;">
    <table id="resultTable">
      <thead><tr></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="hint">æ³¨ï¼šè¡¨æ ¼ä¸­ç©ºç™½å•å…ƒæ ¼ä¼šæ ‡çº¢ï¼Œè¡¨ç¤ºå¯èƒ½æ¼è¯‘ï¼›HTML æ ‡ç­¾ï¼ˆå¦‚ &lt;br&gt;ï¼‰ä¸å ä½ç¬¦ä¼šåŸæ ·ä¿ç•™å¹¶æŒ‰åŸä½æ¸²æŸ“ã€‚</div>
</div>

<div class="toast" id="toast">å·²å¤åˆ¶</div>

<script>
const API = "https://localize-proxy.ne0s0u1-pd.workers.dev";
const EXPECT_HEADER = ["zh","ja","de","pt","es","fr","ko","tw","vi"];

const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));

// ä»æ‰¹å¤§å°è¾“å…¥æ¡†å–å€¼ï¼ˆæ²¡æœ‰å°±é»˜è®¤ 50ï¼‰
function getBatchSize(){
  const elInput = document.getElementById("batchSize");
  const v = elInput ? parseInt(elInput.value,10) : 50;
  return Number.isFinite(v) && v > 0 ? v : 50;
}
  
const el = {
  src: document.getElementById("sourceText"),
  status: document.getElementById("status"),
  tableWrap: document.getElementById("tableWrap"),
  table: document.getElementById("resultTable"),
  theadRow: document.querySelector("#resultTable thead tr"),
  tbody: document.querySelector("#resultTable tbody"),
  runBtn: document.getElementById("runBtn"),
  copyBtn: document.getElementById("copyBtn"),
  dlBtn: document.getElementById("dlBtn"),
  toast: document.getElementById("toast"),
};

// æ‹–æ‹½é€»è¾‘
const list = document.getElementById('headerList');
let dragItem = null;
list.addEventListener('dragstart', e => {
  dragItem = e.target;
  e.target.classList.add('dragging');
});
list.addEventListener('dragend', e => {
  e.target.classList.remove('dragging');
  dragItem = null;
});
list.addEventListener('dragover', e => {
  e.preventDefault();
  const target = e.target.closest('li');
  if (target && target !== dragItem) {
    const rect = target.getBoundingClientRect();
    const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
    list.insertBefore(dragItem, next ? target.nextSibling : target);
  }
});
function getHeaderOrder() {
  return Array.from(list.querySelectorAll('li')).map(li => li.dataset.code);
}

function showToast(msg){
  el.toast.textContent = msg;
  el.toast.classList.add("show");
  setTimeout(()=> el.toast.classList.remove("show"), 1600);
}

function sanitizeKeepBr(html){
  return html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
}

function splitLines(s){
  return s.split(/\r?\n/).filter(line => line.trim().length>0);
}

function parseTSV(tsv){
  tsv = tsv.replace(/^```[\s\S]*?\n/,"").replace(/```$/,"").trim();
  const lines = tsv.split(/\r?\n/);
  const rows = lines.map(line => line.split("\t"));
  return rows;
}

function renderTable(rows, inputLineCount){
  // ç¬¬ä¸€è¡Œå°±æ˜¯åç«¯è¿”å›çš„åŠ¨æ€è¡¨å¤´
  const header = rows[0] || [];

  // æ¸²æŸ“è¡¨å¤´
  el.theadRow.innerHTML = "";
  header.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    el.theadRow.appendChild(th);
  });

  // æ¸²æŸ“æ•°æ®è¡Œ
  el.tbody.innerHTML = "";
  const dataRows = rows.slice(1);
  const missingCells = { count: 0 };

  dataRows.forEach((cols) => {
    const tr = document.createElement("tr");
    for (let i = 0; i < header.length; i++) {
      const td = document.createElement("td");
      const raw = (cols[i] ?? "").trim();
      if (!raw) {
        td.classList.add("missing");
        missingCells.count++;
      }
      td.innerHTML = sanitizeKeepBr(raw);
      tr.appendChild(td);
    }
    el.tbody.appendChild(tr);
  });

  // æ˜¾ç¤ºå®¹å™¨
  el.tableWrap.style.display = "block";

  // è‡ªæ£€ï¼šè¡Œæ•°
  const outLines = dataRows.length;
  if (outLines !== inputLineCount) {
    el.status.className = "status warn";
    el.status.textContent = `âš ï¸ è¡Œæ•°ä¸ä¸€è‡´ï¼šè¾“å…¥ ${inputLineCount} è¡Œï¼Œè¾“å‡º ${outLines} è¡Œï¼›ç©ºå•å…ƒæ ¼ ${missingCells.count} ä¸ªã€‚`;
  } else if (missingCells.count > 0) {
    el.status.className = "status warn";
    el.status.textContent = `âš ï¸ æ£€æµ‹åˆ° ${missingCells.count} ä¸ªç©ºå•å…ƒæ ¼ï¼ˆå¯èƒ½æ¼è¯‘ï¼‰ã€‚`;
  } else {
    el.status.className = "status ok";
    el.status.textContent = "âœ… ç¿»è¯‘å®Œæˆï¼Œè¡Œæ•°åŒ¹é…ï¼Œæ— ç©ºå•å…ƒæ ¼ã€‚";
  }
}


async function translateAndRender(){
  const input = el.src.value.trim();
  const examplesEl = document.getElementById("bestExamples");
  const examples = examplesEl ? examplesEl.value.trim() : "";
  const inputLines = splitLines(el.src.value);

  if (!input){
    alert("è¯·è¾“å…¥è‹±æ–‡ï¼ˆæ¯è¡Œä¸€ä¸ªçŸ­è¯­/å¥å­ï¼‰");
    return;
  }

  const BATCH_SIZE = getBatchSize();
  el.status.className = "status";
  el.status.textContent = "å‡†å¤‡åˆ†æ‰¹â€¦";
  el.tableWrap.style.display = "none";

  try {
    const total = inputLines.length;
    let offset = 0;
    let firstBatch = true;
    let combinedTSV = "";

    const totalBatches = Math.ceil(total / BATCH_SIZE);

    for (let batchIndex = 1; batchIndex <= totalBatches; batchIndex++) {
      // è¿›åº¦æç¤º
      el.status.textContent = `ç¿»è¯‘ä¸­â€¦ ç¬¬ ${batchIndex} / ${totalBatches} æ‰¹ï¼ˆ${BATCH_SIZE} è¡Œ/æ‰¹ï¼‰`;

      const res = await fetch(API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text: input,                     // æ•´ä½“åŸæ–‡ï¼›åç«¯ç”¨ offset/batchSize åˆ‡æœ¬æ‰¹
          examples,                        // ä½ çš„æœ€ä½³æœ¬åœŸåŒ–ç¤ºä¾‹
          headerOrder: getHeaderOrder(),   // æ‹–æ‹½åçš„è¡¨å¤´é¡ºåº
          offset,                          // æœ¬æ‰¹èµ·å§‹è¡Œ
          batchSize: BATCH_SIZE            // æœ¬æ‰¹å¤§å°
        })
      });

      if (!res.ok) {
        const errText = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status}: ${errText || "è¯·æ±‚å¤±è´¥"}`);
      }

      const data = await res.json();

      // 429/é™æµå®¹é”™ï¼šåç«¯å¯èƒ½è¿”å› retryAfterMs
      if (data.error) {
        if (data.retryAfterMs) {
          const wait = Math.max(1200, data.retryAfterMs);
          el.status.textContent = `è§¦å‘é™æµï¼Œ${Math.ceil(wait/1000)} ç§’åç»§ç»­â€¦`;
          await sleep(wait);
          batchIndex--; // é‡è¯•å½“å‰æ‰¹
          continue;
        }
        throw new Error(data.error?.message || "åç«¯é”™è¯¯");
      }

      // é¦–æ‰¹åŒ…å«è¡¨å¤´ï¼›åç»­æ‰¹åªæœ‰æ•°æ®è¡Œ
      const tsvPiece = (data.table || "").trim();
      if (!tsvPiece) throw new Error("åç«¯è¿”å›ç©ºçš„ TSV ç‰‡æ®µ");

      if (firstBatch) {
        combinedTSV = tsvPiece;
        firstBatch = false;
      } else {
        combinedTSV += "\n" + tsvPiece;
      }

      // æ¨è¿› offset
      const meta = data.meta || {};
      if (!meta.hasMore) break;
      offset = meta.nextOffset;

      // è½»å¾®èŠ‚æµï¼Œé¿å…å…è´¹é¢åº¦è¢«é™
      await sleep(1200);
    }

    // æ¸²æŸ“æ•´è¡¨
    const rows = parseTSV(combinedTSV);
    renderTable(rows, inputLines.length);
    el.tableWrap.dataset.tsv = combinedTSV;

    el.status.className = "status ok";
    el.status.textContent = "âœ… ç¿»è¯‘å®Œæˆ";
  } catch (e){
    el.status.className = "status warn";
    el.status.textContent = "è¯·æ±‚å¤±è´¥ï¼š" + e.message;
  }
}



async function robustCopy(text) {
  if (!window.isSecureContext) throw new Error("é HTTPS å®‰å…¨ç¯å¢ƒï¼Œæ— æ³•å†™å…¥å‰ªè´´æ¿");
  if (navigator.clipboard && navigator.clipboard.writeText){
    try {
      if (navigator.permissions && navigator.permissions.query){
        await navigator.permissions.query({ name: "clipboard-write" });
      }
    } catch(_) {}
    await navigator.clipboard.writeText(text);
    return;
  }
  const ta = document.createElement("textarea");
  ta.value = text; ta.setAttribute("readonly","");
  ta.style.position="absolute"; ta.style.left="-9999px";
  document.body.appendChild(ta);
  ta.select(); ta.setSelectionRange(0, ta.value.length);
  const ok = document.execCommand("copy");
  document.body.removeChild(ta);
  if (!ok) throw new Error("å¤åˆ¶å¤±è´¥");
}

el.runBtn.addEventListener("click", translateAndRender);
el.copyBtn.addEventListener("click", async ()=>{
  const tsv = el.tableWrap.dataset.tsv || "";
  if (!tsv.trim()){ showToast("æ²¡æœ‰å¯å¤åˆ¶çš„ TSV"); return; }
  try{ await robustCopy(tsv); showToast("å·²å¤åˆ¶ TSV"); }
  catch(e){ showToast("å¤åˆ¶å¤±è´¥"); }
});
el.dlBtn.addEventListener("click", ()=>{
  const tsv = el.tableWrap.dataset.tsv || "";
  if (!tsv.trim()){ showToast("æ²¡æœ‰å¯ä¸‹è½½çš„ TSV"); return; }
  const blob = new Blob([tsv], { type:"text/tab-separated-values;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "translations.tsv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>


